# 02. 開発ワークフロー

## 開発フローの基本原則

このファイルは言語・フレームワークに依存しない開発ワークフローを定義します。

### アトミックコミットの強制

すべてのコミットは以下の原則に従うこと：

1. **1コミット = 1変更**: 各コミットは論理的に1つの変更のみを含む
2. **変更の混在禁止**: コミットメッセージで複数の変更を説明する場合は分割
3. **依存関係例外**: 直接依存がある場合のみ複数ファイルが許可される
4. **独立した取り消し可能性**: 各コミットは他の機能を壊すことなく取り消し可能

### コミットメッセージ規約

```bash
# 形式: <種別>: <説明>

# 種別の定義（日本語）
機能: 新機能の追加
修正: バグの修正
改善: 既存機能の改善
削除: コード・ファイルの削除
移動: ファイル・コードの移動
名前変更: 変数・関数・ファイル名の変更
テスト: テストの追加・修正
文書: ドキュメントのみの変更
設定: 設定ファイルの変更
構成: ディレクトリ構造の変更

# 例
機能: ユーザー認証機能を実装
修正: データベース接続エラーを解決
改善: パフォーマンスを最適化
削除: 不要なデバッグログを削除
テスト: ユーザーサービスのテストケースを追加
```

### 開発ワークフロー

#### 標準開発フロー（単体テストのみ）
1. 特定目的のフィーチャーブランチを作成
2. TDDサイクルでテスト→実装を繰り返し
3. アトミックコミット原則に従って変更をコミット
4. テストを実行してすべて通ることを確認
5. 品質チェック（lint、typecheck）を実行
6. 統合ブランチ（developまたはmain）にマージ
7. マージ後にバージョンアップ（通常はpatch）

#### 統合テスト必須開発フロー
実際のアプリケーションでのテストが必要な場合：

1. 特定目的のフィーチャーブランチを作成
2. TDDサイクルで開発を実施
3. 単体テストを実行
4. **マージ前に開発版作成**:
   - 開発版作成（言語固有のバージョン管理ツール使用）
   - ビルド・パッケージ化
   - 実際のアプリケーションでテスト
   - テスト失敗時は修正して新しい開発版
5. **統合テスト通過後のみ**:
   - 統合ブランチにマージ
   - リリース版にバージョンアップ

### コミット分割例

```bash
# 大きな機能（認証システム）の分割例:

# 1. テスト先行
git add tests/test_auth_service.py tests/test_user_repository.py
git commit -m "テスト: ユーザー認証機能のテストケースを先行作成"

# 2. 機能別の実装（モジュール別）
git add src/auth/user_repository.py
git commit -m "機能: ユーザー情報の永続化機能を実装"

git add src/auth/auth_service.py
git commit -m "機能: 認証ロジックの中核機能を実装"

git add src/auth/password_hasher.py
git commit -m "機能: パスワードハッシュ化機能を実装"

# 3. 統合と設定
git add src/main.py config/auth_config.yaml
git commit -m "統合: 認証サービスをメインアプリケーションに統合"
```

### 品質保証プロセス

#### コミット前チェックリスト
1. **テスト**: すべてのテストが通っているか？
2. **型チェック**: 型チェックがクリーンか？（言語の静的解析ツール）
3. **リント**: コードスタイル違反が修正されているか？
4. **セキュリティ**: シークレットや機密データが含まれていないか？
5. **コミット**: 各コミットがアトミックで適切に説明されているか？
6. **デバッグ**: 一時的なデバッグコードが削除されているか？

#### コードの質を保つ原則

```python
# ❌ ネストが深い
def process_user(user):
    if user:
        if user.active:
            if user.verified:
                # 処理
                pass

# ✅ 早期リターン
def process_user(user):
    if not user:
        return
    if not user.active:
        return
    if not user.verified:
        return

    # 処理
    pass

# ❌ マジックナンバー
if retry_count > 3:
    raise Exception('リトライ回数を超えました')

# ✅ 定数化
MAX_RETRY_COUNT = 3
if retry_count > MAX_RETRY_COUNT:
    raise Exception(f'リトライ回数（{MAX_RETRY_COUNT}回）を超えました')
```

### デバッグ管理戦略

#### デバッグログの追加
- **一時的使用のみ**: デバッグログは能動的なトラブルシューティング用
- **明確なプレフィックス**: `[DEBUG]`、`[TRACE]`等を使用
- **文脈情報**: 関連する状態とパラメータを含める

#### デバッグログの削除
- **個別コミット**: デバッグログ削除は専用コミットで
- **コミットメッセージ**: `削除: 不要なデバッグログ`等
- **完全削除**: コメントアウトではなく完全削除

```python
# 開発時のみ
print(f'[DEBUG] 処理開始: data={data}')

# 本番対応
import logging
logger = logging.getLogger('app.user_service')
logger.debug('ユーザー情報を取得: %s', user_id)
```

### フォーマット規約

#### 言語共通フォーマット
- **インデント**: 言語の慣習に従う（Python: 4スペース、Go: タブ、JS/TS: 2スペース）
- **文字コード**: UTF-8（BOMなし）
- **改行コード**: LF（Unix形式）
- **末尾スペース**: 削除する
- **ファイル末尾**: 改行を入れる

#### 推奨ディレクトリ構造

```text
project/
├── src/              # ソースコード
├── tests/            # テストコード
├── docs/             # ドキュメント
├── scripts/          # ユーティリティスクリプト
├── .env.example      # 環境変数サンプル
├── .gitignore
├── README.md         # 日本語のREADME
├── CLAUDE.md         # Claude用設定
└── agent-rules/     # Agent向けルールセット
    ├── 00-core-principles.md
    └── [other rules]
```

---

**適用優先度**: 🟡 中（開発時は必須遵守）
**更新頻度**: プロジェクト経験に基づいて四半期ごとに見直し