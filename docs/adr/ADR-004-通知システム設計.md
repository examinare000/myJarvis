# ADR-004: 通知システム設計

**ステータス:** 承認済み
**日付:** 2025-09-25
**意思決定者:** 開発チーム

## コンテキスト

「適切な時間・適切なトーンでリマインド通知」を送る機能は、myJarvisアプリのユーザーエンゲージメントを高める上で中心的な役割を担います。サーバーからのトリガーと、クライアントの状況を組み合わせた、柔軟で信頼性の高い通知システムが必要です。

## 要求事項
- 適切な時間での通知配信
- 適切なトーンでのメッセージ生成
- 外部イベント（メール受信、カレンダー更新等）への即応
- オフライン時の動作継続
- ユーザーの現在状況の考慮（使用中アプリ、マナーモード等）

## 検討した選択肢

### 1. 完全サーバープッシュ
- **概要**: バックエンドが通知のタイミングと内容を全て決定し、APNs/FCM経由でプッシュ通知を送信
- **長所**:
  - ロジックがサーバーに集中し、管理が容易
  - 外部イベントへの即応が可能
- **短所**:
  - オフライン時に通知できない
  - クライアントのローカルな状況（使用中アプリ、マナーモード等）を反映しにくい
  - プッシュ通知の制約による表現力の限界

### 2. 完全ローカル通知
- **概要**: クライアントが全てのスケジュールデータを持ち、自身のタイマーでローカル通知をスケジュール
- **長所**:
  - オフラインでも動作
  - プライバシーが高い
  - デバイス状況を柔軟に考慮可能
- **短所**:
  - 外部イベント（急な会議の招待メール等）をトリガーにした通知ができない
  - アプリが長時間起動しないとスケジュールが古くなる
  - バックグラウンド処理の制限

### 3. ハイブリッド通知
- **概要**: サーバーが「いつ頃、何について」という指示をサイレントプッシュで送り、クライアントが最終的なタイミングと内容を決定
- **長所**:
  - サーバーからのトリガーとクライアントの状況判断を組み合わせ
  - 高い柔軟性とインテリジェンス
- **短所**:
  - 実装が複雑
  - サイレントプッシュの信頼性に依存

## 決定

**ハイブリッド通知アプローチを採用します。**

### 決定理由

1. **柔軟性とインテリジェンス**: バックエンドは外部イベントを検知し、適切なトリガーをクライアントに送信
2. **最適なユーザー体験**: クライアントはローカルMLモデルの判断や現在のデバイス状況を考慮し、最適なタイミング・文面で通知を表示
3. **信頼性**: オフライン時でも、既存のスケジュールに基づいてローカル通知を実行可能

## アーキテクチャ設計

### 通知フロー

```
[External Event] → [BFF] → [Silent Push] → [Client] → [Local Notification]
     ↓               ↓           ↓            ↓             ↓
Calendar Update   Event      Trigger      Context       User Sees
Email Received   Detection   Signal     Analysis      Notification
Task Deadline    Analysis    Generation  + Timing      with Perfect
Schedule Change                         Optimization   Tone & Timing
```

### コンポーネント構成

#### サーバーサイド（BFF）
1. **イベント検出エンジン**
   - 外部サービスの変更監視（Webhook/Polling）
   - カレンダー更新、メール受信、タスク期限接近の検出
2. **通知トリガー生成**
   - イベントの重要度・緊急度評価
   - 通知タイプとペイロード決定
3. **プッシュ配信**
   - APNs（iOS）、FCM（Web）への Silent Push 送信

#### クライアントサイド（KMP共有コア）
1. **Silent Push 受信処理**
   - バックグラウンドでのプッシュペイロード解析
   - ローカルコンテキスト情報の収集
2. **コンテキスト分析エンジン**
   - 現在時刻、アプリ使用状況、マナーモード等の状況判断
   - ユーザーの過去の反応パターン分析
3. **通知内容生成**
   - ローカルMLモデルによるパーソナライズされた文面生成
   - 適切なトーン（緊急/丁寧/フレンドリー等）の選択
4. **通知スケジューラ**
   - 最適なタイミングでのローカル通知発火
   - ユーザーの邪魔にならない時間帯の選択

## 通知タイプと戦略

### 通知カテゴリ
1. **緊急通知**: 即座に表示（会議開始5分前等）
2. **重要通知**: 適切なタイミングで表示（タスク期限接近等）
3. **情報通知**: ユーザーが利用可能な時に表示（デイリーサマリー等）
4. **モチベーション通知**: 最適な心理状態で表示（休憩推奨等）

### トーン選択ロジック
- **緊急度**: 高→フォーマル、低→フレンドリー
- **時間帯**: 朝→エネルギッシュ、夜→落ち着いた
- **ユーザー状況**: 忙しい→簡潔、余裕→詳細
- **過去反応**: ポジティブ反応の高いトーンを学習・適用

## 技術実装

### サーバーサイド技術
- **Event Detection**: Webhooks + Polling Scheduler
- **Push Service**:
  - iOS: APNs (Apple Push Notification service)
  - Web: FCM (Firebase Cloud Messaging)
- **Queue Management**: Redis/Bull for reliable delivery

### クライアントサイド技術
- **Background Processing**:
  - iOS: Background App Refresh
  - Web: Service Worker
- **Local ML**: TensorFlow Lite for tone/timing optimization
- **Local Storage**: Encrypted local database for notification history

## 影響と結果

### ポジティブな影響
- 高度にパーソナライズされた通知体験
- 外部イベントへの即応性と、ローカルコンテキストの両立
- オフライン時の基本機能継続
- ユーザーの邪魔にならない配慮されたタイミング

### ネガティブな影響とリスク軽減策
- **実装複雑性**: 段階的な開発とテスト戦略
- **Silent Push 信頼性**: フォールバック機能（定期的なローカル通知）
- **バッテリー消費**: 効率的なバックグラウンド処理の実装

### プライバシー考慮事項
- 通知内容の機微な情報のデバイス内保持
- プッシュペイロードの最小化（IDのみ送信）
- ユーザーの明示的な通知許可設定

## 関連する意思決定
- ADR-001: マルチプラットフォーム戦略（KMP共有コアでの通知ロジック）
- ADR-002: 外部サービス統合戦略（BFF経由のイベント検出）
- ADR-003: AI/MLパイプライン設計（ローカルMLによるトーン最適化）