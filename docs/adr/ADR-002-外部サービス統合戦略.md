# ADR-002: 外部サービス統合戦略

**ステータス:** 承認済み
**日付:** 2025-09-25
**意思決定者:** 開発チーム

## コンテキスト

Googleカレンダー、Gmail、Slackなど、複数の外部サービスとの連携はmyJarvisアプリの根幹機能です。これらのAPIを安全かつ効率的に呼び出し、認証情報を管理し、将来的なサービスの追加・変更に柔軟に対応できるアーキテクチャが必要です。

## 要求事項
- Googleカレンダー、Googleタスク、X、Gmail、Slack連携
- 認証情報の安全な管理
- 外部API仕様変更への柔軟な対応
- 将来的なサービス追加の容易さ

## 検討した選択肢

### 1. クライアント直接統合
- **概要**: iOS/Webアプリから直接、各外部サービスのAPIを呼び出し
- **長所**:
  - サーバーを介さないシンプルな構成
  - レイテンシーの削減
- **短所**:
  - APIキーや認証トークンがクライアント側に分散し、セキュリティリスク大
  - API仕様変更のたびに全クライアントのアップデートが必要
  - 認証フローの複雑化

### 2. BFF (Backend for Frontend) パターン
- **概要**: クライアントは自社のNode.jsサーバーとのみ通信し、サーバーが代理として外部APIと通信
- **長所**:
  - 認証情報をサーバーで一元管理、安全性確保
  - 外部APIの差異をサーバー側で吸収、統一されたAPIを提供
  - クライアントの実装簡素化
- **短所**:
  - サーバー開発コストの発生
  - サーバーが単一障害点になる可能性

### 3. iPaaS (Integration Platform as a Service) 利用
- **概要**: ZapierやMakeのような外部統合サービスを利用
- **長所**:
  - 開発をほとんどせずに多くのサービスと連携
  - 保守運用の外部化
- **短所**:
  - 従量課金によるコスト増
  - リアルタイム性や複雑なデータ処理に制限
  - 外部サービスへの過度な依存

## 決定

**BFF (Backend for Frontend) パターンを採用します。**

### 決定理由

1. **セキュリティ**: ユーザーの認証情報（OAuthトークンなど）やサービスのAPIキーをサーバーサイドで安全に保管・管理
2. **保守性**: 外部APIの仕様変更や廃止があっても、修正はBFFに限定され、クライアントアプリの改修を最小限に抑制
3. **効率性**: 複数のAPIから取得したデータを事前に加工・集約し、クライアント向けに最適化して返すことで処理負荷と通信量を削減

## アーキテクチャ設計

### データフロー
```
[iOS/Web Client]
    ↕ (HTTPS/WSS)
[myJarvis BFF Server (Node.js)]
    ↕ (OAuth 2.0/API Keys)
[External APIs: Google Calendar, Gmail, Slack, etc.]
```

### BFFの責務
- 外部サービスの認証・認可処理
- APIレスポンスの正規化・集約
- レート制限の管理
- エラーハンドリングと再試行制御
- データキャッシング

## 影響と結果

### ポジティブな影響
- 認証情報の集中管理によるセキュリティ向上
- クライアント実装の簡素化
- 外部API変更に対する耐性向上
- 統一されたエラーハンドリング

### ネガティブな影響とリスク軽減策
- **サーバー開発コスト**: Node.js + TypeScriptでの効率的な開発
- **単一障害点**: 冗長化とヘルスチェック機能の実装
- **レイテンシー増加**: 適切なキャッシング戦略で最小化

### 実装に必要な技術要素
- Node.js + Express/Fastify
- OAuth 2.0ライブラリ
- 外部API SDK（Google APIs, Slack SDK等）
- Redis（キャッシング・セッション管理）
- ログ監視・アラート機能

## セキュリティ考慮事項
- 全ての認証トークンの暗号化保存
- HTTPS通信の強制
- レート制限の実装
- APIキーのローテーション機能
- 監査ログの記録

## 関連する意思決定
- ADR-001: マルチプラットフォーム戦略（BFFとの連携）
- ADR-005: データストレージ・プライバシー戦略（認証情報の管理）
- ADR-006: リアルタイム同期戦略（BFF経由の同期）