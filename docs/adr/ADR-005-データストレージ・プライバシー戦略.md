# ADR-005: データストレージ・プライバシー戦略

**ステータス:** 承認済み
**日付:** 2025-09-25
**意思決定者:** 開発チーム

## コンテキスト

myJarvisアプリはライフログ、バイタル情報、満足度など、極めて機密性の高い個人情報を扱います。ユーザーの信頼を勝ち取るためには、「プライバシーバイデザイン」の思想に基づいた厳格なデータ保管と管理戦略が不可欠です。

## 要求事項
- バイタル情報、満足度データ等の機微な個人情報の安全な管理
- マルチデバイス間での必要なデータ同期
- 法的規制（GDPR、個人情報保護法等）への準拠
- ユーザーの信頼獲得とプライバシー透明性
- データ漏洩時のリスク最小化

## 検討した選択肢

### 1. フルクラウドストレージ
- **概要**: 全てのデータを暗号化してクラウドデータベースに保存
- **長所**:
  - データ同期が容易
  - バックアップ・災害復旧が確実
  - スケーラビリティの確保
- **短所**:
  - データ漏洩時のリスクが甚大
  - ユーザーのプライバシーに対する懸念が強い
  - 法的規制への対応コストが高い

### 2. フルローカルストレージ
- **概要**: 全てのデータをデバイス内にのみ保存
- **長所**:
  - プライバシーが最大限保護
  - データ漏洩リスクの最小化
  - 法的規制の影響を受けにくい
- **短所**:
  - デバイス間でのデータ同期ができない
  - 機種変更時のデータ移行が困難
  - データ損失時の復旧不可

### 3. ハイブリッドストレージ
- **概要**: データの機密性に応じて保存場所を分離
- **長所**:
  - プライバシーと利便性のバランス
  - リスクレベルに応じた最適化
- **短所**:
  - データ管理のアーキテクチャが複雑
  - 分類ルールの維持管理が必要

## 決定

**ハイブリッドストレージアプローチを、厳格なデータ分類と共に採用します。**

## データ分類とストレージ戦略

### Tier 1: 極機密データ（ローカルストレージのみ）
**対象データ:**
- バイタル情報（心拍数、血圧、体重等）
- 詳細な行動ログ（位置情報、アプリ使用履歴）
- 満足度スコア、感情データ
- 健康に関する機微な情報
- プライベートなメモ・日記

**実装:**
- iOSのKeychain（認証情報）+ 暗号化されたローカルDB（SQLCipher）
- デバイスのハードウェア暗号化機能を活用
- データはデバイスから外部に一切送信されない

### Tier 2: 中機密データ（暗号化クラウドストレージ）
**対象データ:**
- タスクのタイトルと期限（詳細な内容は除く）
- カレンダーイベントのID・基本情報
- 一般的な設定情報
- デバイス間同期に必要な最小限のデータ

**実装:**
- myJarvisバックエンドサーバー
- 転送時（TLS 1.3）・保存時（AES-256）の暗号化
- データベース暗号化（Transparent Data Encryption）

### Tier 3: 低機密データ（通常のクラウドストレージ）
**対象データ:**
- ユーザーアカウント情報（ID、メールアドレス）
- アプリ設定（機微でない項目）
- 統計情報（匿名化済み）

**実装:**
- 標準的なクラウドデータベース
- HTTPS通信での保護

## セキュリティ実装詳細

### 暗号化戦略
- **保存時暗号化**: AES-256-GCM
- **転送時暗号化**: TLS 1.3 with Perfect Forward Secrecy
- **キー管理**:
  - デバイス: Hardware Security Module (Secure Enclave/TEE)
  - サーバー: AWS KMS / Google Cloud KMS

### 認証・認可
- **多要素認証**: FIDO2/WebAuthn対応
- **デバイス認証**: 端末固有の証明書ベース認証
- **最小権限の原則**: データアクセスを必要最小限に制限

### データライフサイクル管理
- **データ保持期間**:
  - Tier 1: ユーザー削除時まで（デバイス内）
  - Tier 2/3: 明確な保持ポリシー（最大2年）
- **安全な削除**: Cryptographic erasure + Secure wipe
- **データポータビリティ**: ユーザー要求時のデータエクスポート機能

## プライバシー保護メカニズム

### データ最小化
- 機能に必要な最小限のデータのみ収集
- 定期的なデータクリーンアップ
- 匿名化・仮名化の積極的適用

### 用途制限
- 収集目的以外でのデータ利用禁止
- 第三者への提供は事前同意のみ
- AI/ML学習への利用は匿名化データのみ

### 透明性の確保
- データ収集・利用目的の明確な説明
- プライバシーポリシーの平易な言語での記述
- ユーザーによるデータアクセス・削除権の保障

## 法的規制への対応

### GDPR準拠
- 合法的根拠（同意・正当利益）の明確化
- データ主体の権利（アクセス、訂正、削除、ポータビリティ）の実装
- DPO（データ保護責任者）の指名
- DPIA（データ保護影響評価）の実施

### 日本の個人情報保護法準拠
- 個人情報の適正な取得・利用
- 安全管理措置の実施
- 第三者提供時の同意取得
- 個人情報保護委員会への報告体制

## 技術実装

### ローカルストレージ技術
- **iOS**: Core Data + SQLCipher, Keychain Services
- **Web**: IndexedDB with encryption, Web Crypto API
- **KMP共通**: SQLite + SQLCipher binding

### クラウドストレージ技術
- **Database**: PostgreSQL with TDE
- **Encryption**: Server-side encryption with customer-managed keys
- **Access Control**: Fine-grained IAM policies

### 監査・ログ機能
- 全てのデータアクセスログの記録
- 異常アクセスの検知・アラート
- 定期的なセキュリティ監査

## 影響と結果

### ポジティブな影響
- ユーザーの信頼獲得と安心感の提供
- 法的規制への確実な準拠
- データ漏洩時のリスクの最小化
- 競合優位性の確保（プライバシー重視）

### ネガティブな影響とリスク軽減策
- **実装複雑性**: 段階的な実装とコードレビュー強化
- **開発コスト増加**: セキュリティバイデザインによる長期的コスト削減
- **パフォーマンスへの影響**: 最適化された暗号化ライブラリの利用

### 運用体制
- セキュリティ専門チームの設置
- 定期的な脆弱性診断・ペネトレーションテスト
- インシデントレスポンス計画の策定
- ユーザーサポート体制（プライバシー関連問い合わせ）

## 関連する意思決定
- ADR-001: マルチプラットフォーム戦略（KMP共有でのセキュリティ実装）
- ADR-002: 外部サービス統合戦略（認証情報の安全な管理）
- ADR-003: AI/MLパイプライン設計（機微データのローカル処理）
- ADR-004: 通知システム設計（プッシュペイロードの最小化）