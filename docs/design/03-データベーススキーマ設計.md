# データベーススキーマ設計書

**バージョン:** 1.0
**日付:** 2025-09-25
**ステータス:** 初版
**作成者:** 開発チーム

## 1. 概要と目的

### 1.1 概要
本設計書は、myJarvis システムで使用するデータベーススキーマの詳細設計を定義します。プライバシー保護の観点から、機微データはローカル保存、同期に必要な基本データのみクラウド保存する階層化ストレージ戦略に基づいています。

### 1.2 設計原則
- **プライバシーバイデザイン**: 機微データのクラウド保存回避
- **最小データ原則**: 同期に必要な最小限のデータのみサーバー保存
- **リアルタイム同期**: 複数デバイス間でのデータ整合性確保
- **スケーラビリティ**: 大規模ユーザー数への対応
- **データ整合性**: ACID特性の保証

### 1.3 対象読者
- データベース設計者
- バックエンド開発者
- システム運用担当者
- セキュリティ担当者

## 2. データベース構成

### 2.1 技術選定

**主データベース**: PostgreSQL 15+
- **選定理由**: ACID準拠、JSON型サポート、高性能、豊富な拡張機能
- **暗号化**: Transparent Data Encryption (TDE)
- **バックアップ**: Point-in-time Recovery対応

**キャッシュ**: Redis 7+
- **用途**: セッション管理、Pub/Sub、APIレスポンスキャッシュ
- **クラスター構成**: 高可用性確保

**ローカルDB**: SQLite + SQLCipher
- **用途**: 機微データのデバイス内保存
- **暗号化**: AES-256ハードウェア暗号化

### 2.2 データ分類と配置

| データ分類 | 保存場所 | 暗号化レベル | 例 |
|-----------|---------|------------|---|
| **Tier 1: 極機密** | ローカルのみ | ハードウェア暗号 | バイタル情報、詳細行動ログ、満足度 |
| **Tier 2: 中機密** | PostgreSQL | TDE + AES-256 | タスク基本情報、設定 |
| **Tier 3: 低機密** | PostgreSQL | TDE | ユーザーアカウント、統計情報 |

## 3. PostgreSQL スキーマ設計

### 3.1 ユーザー・認証管理

#### users テーブル
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    password_hash VARCHAR(255) NOT NULL, -- Argon2id
    mfa_enabled BOOLEAN DEFAULT FALSE,
    mfa_secret VARCHAR(255), -- 暗号化済み
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'deleted')),

    -- 監査情報
    created_by UUID,
    updated_by UUID,

    CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- Row Level Security
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY users_policy ON users FOR ALL TO authenticated_users
    USING (id = current_user_id());
```

#### user_sessions テーブル
```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    device_id VARCHAR(255) NOT NULL,
    device_info JSONB NOT NULL,
    refresh_token_hash VARCHAR(255) NOT NULL, -- ハッシュ化済み
    access_token_jti UUID NOT NULL, -- JWT ID
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    ip_address INET,
    user_agent TEXT,
    is_revoked BOOLEAN DEFAULT FALSE,

    CONSTRAINT unique_device_per_user UNIQUE(user_id, device_id)
);

CREATE INDEX idx_sessions_user_device ON user_sessions(user_id, device_id);
CREATE INDEX idx_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_sessions_token_hash ON user_sessions(refresh_token_hash);

-- 期限切れセッションの自動削除
CREATE OR REPLACE FUNCTION cleanup_expired_sessions()
RETURNS TRIGGER AS $$
BEGIN
    DELETE FROM user_sessions
    WHERE expires_at < NOW() - INTERVAL '1 day';
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER cleanup_sessions_trigger
    AFTER INSERT ON user_sessions
    EXECUTE FUNCTION cleanup_expired_sessions();
```

#### user_preferences テーブル
```sql
CREATE TABLE user_preferences (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    timezone VARCHAR(50) DEFAULT 'UTC',
    language VARCHAR(10) DEFAULT 'ja',
    date_format VARCHAR(20) DEFAULT 'YYYY-MM-DD',
    time_format VARCHAR(10) DEFAULT '24h',

    -- 通知設定
    notifications JSONB DEFAULT '{
        "push_enabled": true,
        "email_enabled": false,
        "task_reminders": true,
        "schedule_updates": true,
        "quiet_hours": {
            "enabled": false,
            "start": "22:00",
            "end": "07:00"
        }
    }',

    -- 作業スタイル設定
    work_preferences JSONB DEFAULT '{
        "work_style": "balanced",
        "energy_patterns": {
            "morning": 0.8,
            "afternoon": 0.7,
            "evening": 0.5
        },
        "preferred_break_duration": 15,
        "max_continuous_work": 120
    }',

    -- プライバシー設定
    privacy_settings JSONB DEFAULT '{
        "data_sharing": false,
        "analytics": true,
        "personalization": true
    }',

    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス（JSONB用）
CREATE INDEX idx_user_prefs_notifications ON user_preferences USING GIN (notifications);
CREATE INDEX idx_user_prefs_work ON user_preferences USING GIN (work_preferences);
```

### 3.2 タスク・スケジュール管理

#### sync_tasks テーブル
```sql
CREATE TABLE sync_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- 基本情報（機微でない）
    title VARCHAR(500) NOT NULL,
    description TEXT, -- 可能な限り簡潔な説明のみ
    status VARCHAR(20) DEFAULT 'active'
        CHECK (status IN ('active', 'completed', 'archived', 'deleted')),
    priority VARCHAR(10) DEFAULT 'medium'
        CHECK (priority IN ('low', 'medium', 'high', 'urgent')),

    -- 時間情報
    due_date TIMESTAMP WITH TIME ZONE,
    estimated_duration INTEGER, -- 秒単位
    completed_at TIMESTAMP WITH TIME ZONE,

    -- 外部サービス連携
    external_references JSONB DEFAULT '[]',
    -- [{"type": "google_calendar", "id": "event_123", "sync_status": "synced"}]

    -- バージョン管理（楽観的ロック）
    version INTEGER DEFAULT 1,

    -- タイムスタンプ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- ソフトデリート
    deleted_at TIMESTAMP WITH TIME ZONE,

    CONSTRAINT title_length CHECK (LENGTH(title) >= 1),
    CONSTRAINT valid_duration CHECK (estimated_duration IS NULL OR estimated_duration > 0)
);

CREATE INDEX idx_sync_tasks_user_id ON sync_tasks(user_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_sync_tasks_status ON sync_tasks(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_sync_tasks_due_date ON sync_tasks(due_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_sync_tasks_updated_at ON sync_tasks(updated_at);
CREATE INDEX idx_sync_tasks_external_refs ON sync_tasks USING GIN (external_references);

-- Row Level Security
ALTER TABLE sync_tasks ENABLE ROW LEVEL SECURITY;
CREATE POLICY sync_tasks_policy ON sync_tasks FOR ALL TO authenticated_users
    USING (user_id = current_user_id());
```

#### task_subtasks テーブル
```sql
CREATE TABLE task_subtasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_task_id UUID NOT NULL REFERENCES sync_tasks(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    title VARCHAR(500) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'active'
        CHECK (status IN ('active', 'completed', 'archived')),

    -- 順序・依存関係
    order_index INTEGER NOT NULL DEFAULT 0,
    dependencies UUID[] DEFAULT '{}', -- 依存する他のsubtaskのID配列

    -- 時間情報
    estimated_duration INTEGER,
    completed_at TIMESTAMP WITH TIME ZONE,

    -- LLM分解メタデータ
    llm_metadata JSONB DEFAULT '{}',
    -- {"model": "gemini-2.5-pro", "confidence": 0.87, "generated_at": "..."}

    version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_subtasks_parent_task ON task_subtasks(parent_task_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_subtasks_user_id ON task_subtasks(user_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_subtasks_order ON task_subtasks(parent_task_id, order_index);

-- Row Level Security
ALTER TABLE task_subtasks ENABLE ROW LEVEL SECURITY;
CREATE POLICY subtasks_policy ON task_subtasks FOR ALL TO authenticated_users
    USING (user_id = current_user_id());
```

#### schedules テーブル
```sql
CREATE TABLE schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    name VARCHAR(255) NOT NULL,
    description TEXT,
    schedule_type VARCHAR(20) DEFAULT 'optimized'
        CHECK (schedule_type IN ('manual', 'optimized', 'template')),

    -- 時間範囲
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,

    -- 最適化メタデータ
    optimization_metadata JSONB DEFAULT '{}',
    -- {"algorithm_version": "v2.1", "efficiency_score": 0.89, "generated_at": "..."}

    status VARCHAR(20) DEFAULT 'active'
        CHECK (status IN ('draft', 'active', 'completed', 'archived')),

    version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT valid_date_range CHECK (start_date <= end_date)
);

CREATE INDEX idx_schedules_user_id ON schedules(user_id);
CREATE INDEX idx_schedules_date_range ON schedules(start_date, end_date);
CREATE INDEX idx_schedules_status ON schedules(status);
```

#### schedule_items テーブル
```sql
CREATE TABLE schedule_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    schedule_id UUID NOT NULL REFERENCES schedules(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- 関連タスク（NULLの場合は休憩等）
    task_id UUID REFERENCES sync_tasks(id) ON DELETE CASCADE,
    subtask_id UUID REFERENCES task_subtasks(id) ON DELETE CASCADE,

    -- 時間設定
    scheduled_start TIMESTAMP WITH TIME ZONE NOT NULL,
    scheduled_end TIMESTAMP WITH TIME ZONE NOT NULL,
    actual_start TIMESTAMP WITH TIME ZONE,
    actual_end TIMESTAMP WITH TIME ZONE,

    -- アイテム種別
    item_type VARCHAR(20) DEFAULT 'task'
        CHECK (item_type IN ('task', 'break', 'meeting', 'focus_time', 'buffer')),

    -- 最適化情報
    confidence_score DECIMAL(3,2) DEFAULT 0.0, -- 0.00-1.00
    optimization_notes TEXT,

    status VARCHAR(20) DEFAULT 'scheduled'
        CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled', 'rescheduled')),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT valid_time_range CHECK (scheduled_start < scheduled_end),
    CONSTRAINT valid_confidence CHECK (confidence_score >= 0.0 AND confidence_score <= 1.0),
    CONSTRAINT task_or_subtask_not_both CHECK (
        (task_id IS NOT NULL AND subtask_id IS NULL) OR
        (task_id IS NULL AND subtask_id IS NOT NULL) OR
        (task_id IS NULL AND subtask_id IS NULL)
    )
);

CREATE INDEX idx_schedule_items_schedule_id ON schedule_items(schedule_id);
CREATE INDEX idx_schedule_items_time_range ON schedule_items(scheduled_start, scheduled_end);
CREATE INDEX idx_schedule_items_task_id ON schedule_items(task_id);
CREATE INDEX idx_schedule_items_status ON schedule_items(status);
```

### 3.3 外部サービス統合

#### service_integrations テーブル
```sql
CREATE TABLE service_integrations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    service_type VARCHAR(50) NOT NULL
        CHECK (service_type IN ('google', 'slack', 'microsoft', 'github')),
    service_user_id VARCHAR(255), -- 外部サービス内のユーザーID

    -- 認証情報（暗号化済み）
    encrypted_access_token TEXT NOT NULL,
    encrypted_refresh_token TEXT,
    token_expires_at TIMESTAMP WITH TIME ZONE,

    -- 権限スコープ
    granted_scopes TEXT[] DEFAULT '{}',

    -- 同期設定
    sync_enabled BOOLEAN DEFAULT TRUE,
    sync_preferences JSONB DEFAULT '{}',
    -- {"sync_calendar": true, "sync_emails": false, "sync_frequency": "realtime"}

    last_sync_at TIMESTAMP WITH TIME ZONE,
    sync_cursor VARCHAR(255), -- 増分同期用カーソル

    status VARCHAR(20) DEFAULT 'active'
        CHECK (status IN ('active', 'expired', 'revoked', 'error')),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT unique_user_service UNIQUE(user_id, service_type)
);

CREATE INDEX idx_integrations_user_service ON service_integrations(user_id, service_type);
CREATE INDEX idx_integrations_status ON service_integrations(status);
CREATE INDEX idx_integrations_sync_needed ON service_integrations(user_id, sync_enabled)
    WHERE status = 'active';
```

#### sync_jobs テーブル
```sql
CREATE TABLE sync_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    integration_id UUID NOT NULL REFERENCES service_integrations(id) ON DELETE CASCADE,

    job_type VARCHAR(20) DEFAULT 'full'
        CHECK (job_type IN ('full', 'incremental', 'webhook')),

    status VARCHAR(20) DEFAULT 'pending'
        CHECK (status IN ('pending', 'running', 'completed', 'failed', 'cancelled')),

    -- 進行状況
    progress INTEGER DEFAULT 0, -- 0-100
    total_items INTEGER DEFAULT 0,
    processed_items INTEGER DEFAULT 0,

    -- 結果
    results JSONB DEFAULT '{}',
    -- {"calendar_events": 15, "emails": 32, "errors": 1}

    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,

    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT valid_progress CHECK (progress >= 0 AND progress <= 100)
);

CREATE INDEX idx_sync_jobs_user_id ON sync_jobs(user_id);
CREATE INDEX idx_sync_jobs_integration ON sync_jobs(integration_id);
CREATE INDEX idx_sync_jobs_status ON sync_jobs(status);
CREATE INDEX idx_sync_jobs_created_at ON sync_jobs(created_at DESC);
```

### 3.4 通知管理

#### notification_settings テーブル
```sql
CREATE TABLE notification_settings (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

    -- デバイストークン管理
    device_tokens JSONB DEFAULT '[]',
    -- [{"token": "...", "device_type": "ios", "app_version": "1.0.0", "registered_at": "..."}]

    -- 通知設定
    push_enabled BOOLEAN DEFAULT TRUE,
    email_enabled BOOLEAN DEFAULT FALSE,

    -- 通知種別設定
    notification_types JSONB DEFAULT '{
        "task_reminders": true,
        "schedule_updates": true,
        "deadline_alerts": true,
        "sync_notifications": false,
        "system_updates": true
    }',

    -- クワイエットタイム
    quiet_hours JSONB DEFAULT '{
        "enabled": false,
        "start": "22:00",
        "end": "07:00",
        "timezone": "Asia/Tokyo"
    }',

    -- 通知トーン設定
    tone_preferences JSONB DEFAULT '{
        "urgency_high": "formal",
        "urgency_medium": "friendly",
        "urgency_low": "casual"
    }',

    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_notif_settings_tokens ON notification_settings USING GIN (device_tokens);
```

#### notification_history テーブル
```sql
CREATE TABLE notification_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    notification_type VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,

    -- 送信情報
    sent_via VARCHAR(20) NOT NULL CHECK (sent_via IN ('push', 'email', 'websocket')),
    device_token VARCHAR(500), -- プッシュ通知の場合のデバイストークン

    -- ステータス
    status VARCHAR(20) DEFAULT 'sent'
        CHECK (status IN ('pending', 'sent', 'delivered', 'opened', 'failed')),

    -- メタデータ
    payload JSONB DEFAULT '{}',
    error_message TEXT,

    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    delivered_at TIMESTAMP WITH TIME ZONE,
    opened_at TIMESTAMP WITH TIME ZONE,

    -- 自動削除（30日後）
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days')
);

CREATE INDEX idx_notif_history_user_id ON notification_history(user_id, sent_at DESC);
CREATE INDEX idx_notif_history_status ON notification_history(status);
CREATE INDEX idx_notif_history_expires ON notification_history(expires_at);

-- 期限切れ通知の自動削除
CREATE OR REPLACE FUNCTION cleanup_expired_notifications()
RETURNS TRIGGER AS $$
BEGIN
    DELETE FROM notification_history
    WHERE expires_at < NOW();
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER cleanup_notifications_trigger
    AFTER INSERT ON notification_history
    EXECUTE FUNCTION cleanup_expired_notifications();
```

### 3.5 システム・監査ログ

#### audit_logs テーブル
```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,

    -- 操作情報
    action VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id UUID,

    -- 変更内容
    old_values JSONB,
    new_values JSONB,

    -- リクエスト情報
    ip_address INET,
    user_agent TEXT,
    request_id VARCHAR(255),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- パーティション用カラム（月次パーティション）
    created_month DATE GENERATED ALWAYS AS (DATE_TRUNC('month', created_at)) STORED
);

CREATE INDEX idx_audit_user_id ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_created_at ON audit_logs(created_at DESC);

-- パーティション設定（月次）
-- 実装時にパーティション戦略を適用
```

## 4. Redis スキーマ設計

### 4.1 セッション管理

```redis
# ユーザーセッション
session:{session_id}
  user_id: UUID
  device_id: string
  last_activity: timestamp
  expires_at: timestamp
  TTL: 1800 (30分)

# デバイス別アクティブセッション
user_sessions:{user_id}
  set of session_ids
  TTL: 86400 (24時間)
```

### 4.2 Pub/Sub チャネル

```redis
# リアルタイム同期
channel:sync:{user_id}
  message: {
    type: "task_update|schedule_change|notification",
    resource_id: UUID,
    operation: "create|update|delete",
    data: {...},
    timestamp: timestamp
  }

# システム通知
channel:system:notifications
  message: {
    type: "maintenance|update",
    message: string,
    severity: "info|warning|critical"
  }
```

### 4.3 キャッシュストラテジー

```redis
# APIレスポンスキャッシュ
cache:api:{endpoint_hash}:{user_id}
  data: JSON response
  TTL: 300 (5分)

# 外部APIレスポンスキャッシュ
cache:external:{service}:{endpoint_hash}
  data: normalized response
  TTL: 1800 (30分)

# ユーザー設定キャッシュ
cache:user_prefs:{user_id}
  data: user preferences JSON
  TTL: 3600 (1時間)
```

## 5. ローカルDB (SQLite) 設計

### 5.1 機微データテーブル

```sql
-- 詳細タスクデータ（機微情報含む）
CREATE TABLE local_tasks (
    id TEXT PRIMARY KEY,
    sync_task_id TEXT, -- server側のsync_tasksテーブルとの関連

    -- 機微な詳細情報
    detailed_description TEXT,
    private_notes TEXT,
    location_context TEXT,

    -- ユーザー行動データ
    actual_duration INTEGER,
    interruption_count INTEGER,
    focus_quality_score REAL, -- 0.0-1.0

    -- 感情・満足度データ
    satisfaction_score REAL, -- 1.0-5.0
    energy_level_before REAL, -- 0.0-1.0
    energy_level_after REAL, -- 0.0-1.0
    mood_before TEXT,
    mood_after TEXT,

    completed_at TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- バイタル・ライフログデータ
CREATE TABLE vital_logs (
    id TEXT PRIMARY KEY,
    log_date TEXT NOT NULL, -- YYYY-MM-DD
    log_time TEXT NOT NULL, -- HH:MM:SS

    -- バイタル情報
    heart_rate INTEGER,
    blood_pressure_systolic INTEGER,
    blood_pressure_diastolic INTEGER,
    weight REAL,
    sleep_duration INTEGER, -- 分
    sleep_quality_score REAL, -- 0.0-1.0

    -- 活動データ
    steps INTEGER,
    active_minutes INTEGER,
    screen_time_minutes INTEGER,

    -- 感情・気分データ
    mood_score REAL, -- 1.0-5.0
    stress_level REAL, -- 0.0-1.0
    notes TEXT,

    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- ユーザー行動パターン
CREATE TABLE behavior_patterns (
    id TEXT PRIMARY KEY,
    date TEXT NOT NULL, -- YYYY-MM-DD

    -- 時間帯別エネルギーレベル
    energy_morning REAL DEFAULT 0.8,
    energy_afternoon REAL DEFAULT 0.7,
    energy_evening REAL DEFAULT 0.5,

    -- 集中力パターン
    focus_sessions_count INTEGER DEFAULT 0,
    average_focus_duration INTEGER DEFAULT 0, -- 分
    best_focus_time TEXT, -- HH:MM

    -- 休憩パターン
    break_frequency INTEGER DEFAULT 0, -- 1時間あたり
    preferred_break_duration INTEGER DEFAULT 15, -- 分

    -- 学習データ（ML用）
    ml_features TEXT, -- JSON encoded features

    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- MLモデルの予測結果・学習データ
CREATE TABLE ml_predictions (
    id TEXT PRIMARY KEY,
    prediction_type TEXT NOT NULL, -- schedule_optimization, satisfaction_prediction
    input_features TEXT NOT NULL, -- JSON
    prediction_result TEXT NOT NULL, -- JSON
    confidence_score REAL,
    actual_outcome TEXT, -- フィードバック受信後に更新
    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

### 5.2 インデックス設計

```sql
-- パフォーマンス最適化用インデックス
CREATE INDEX idx_vital_logs_date ON vital_logs(log_date, log_time);
CREATE INDEX idx_behavior_patterns_date ON behavior_patterns(date);
CREATE INDEX idx_local_tasks_sync_id ON local_tasks(sync_task_id);
CREATE INDEX idx_ml_predictions_type ON ml_predictions(prediction_type, created_at);
```

### 5.3 暗号化設定

```sql
-- SQLCipher 設定
PRAGMA key = 'user-specific-encryption-key';
PRAGMA cipher_page_size = 4096;
PRAGMA kdf_iter = 256000;
PRAGMA cipher_memory_security = ON;
PRAGMA cipher_kdf_algorithm = PBKDF2_HMAC_SHA512;
PRAGMA cipher_default_kdf_algorithm = PBKDF2_HMAC_SHA512;
```

## 6. データマイグレーション戦略

### 6.1 スキーマバージョン管理

```sql
CREATE TABLE schema_migrations (
    version VARCHAR(20) PRIMARY KEY,
    description TEXT NOT NULL,
    applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    rollback_sql TEXT
);

-- バージョン例: 20250925_001_initial_schema
INSERT INTO schema_migrations (version, description)
VALUES ('20250925_001', 'Initial database schema');
```

### 6.2 マイグレーション例

```sql
-- 20250926_001_add_task_categories.sql
ALTER TABLE sync_tasks ADD COLUMN category_id UUID REFERENCES task_categories(id);
CREATE INDEX idx_sync_tasks_category ON sync_tasks(category_id);

-- ロールバック用SQL
-- ALTER TABLE sync_tasks DROP COLUMN category_id;
```

## 7. パフォーマンス最適化

### 7.1 インデックス戦略

```sql
-- 複合インデックス（最も頻繁なクエリパターン）
CREATE INDEX idx_sync_tasks_user_status_due ON sync_tasks(user_id, status, due_date)
    WHERE deleted_at IS NULL;

CREATE INDEX idx_schedule_items_time_user ON schedule_items(scheduled_start, scheduled_end, user_id);

-- 部分インデックス（条件付きインデックス）
CREATE INDEX idx_active_integrations ON service_integrations(user_id, service_type)
    WHERE status = 'active';

-- カバリングインデックス
CREATE INDEX idx_tasks_list_covering ON sync_tasks(user_id, status)
    INCLUDE (title, due_date, priority, updated_at)
    WHERE deleted_at IS NULL;
```

### 7.2 クエリ最適化

```sql
-- EXPLAIN ANALYZE を使用した実行計画確認
EXPLAIN (ANALYZE, BUFFERS)
SELECT t.id, t.title, t.due_date, t.priority
FROM sync_tasks t
WHERE t.user_id = $1
  AND t.status = 'active'
  AND t.deleted_at IS NULL
ORDER BY t.due_date ASC NULLS LAST, t.priority DESC
LIMIT 50;

-- パーティション戦略（大規模データ対応）
-- 月次パーティション for audit_logs
CREATE TABLE audit_logs_y2025m09 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');
```

### 7.3 接続プール設定

```javascript
// Node.js - pg-pool 設定例
const pool = new Pool({
  host: process.env.DB_HOST,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  port: process.env.DB_PORT,

  // 接続プール設定
  min: 2,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,

  // SSL設定
  ssl: {
    rejectUnauthorized: true,
    ca: fs.readFileSync('/path/to/ca-certificate.crt').toString()
  }
});
```

## 8. バックアップ・災害復旧

### 8.1 バックアップ戦略

```bash
#!/bin/bash
# PostgreSQL バックアップスクリプト

# 日次フルバックアップ
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME -Fc > \
  backup_$(date +%Y%m%d_%H%M%S).dump

# Point-in-time Recovery用WALアーカイブ
archive_command = 'cp %p /backup/wal_archive/%f'

# Redis バックアップ
redis-cli --rdb /backup/redis/dump_$(date +%Y%m%d_%H%M%S).rdb
```

### 8.2 データ保持ポリシー

| データ種別 | 保持期間 | バックアップ頻度 |
|-----------|---------|----------------|
| ユーザーデータ | 無期限 | 日次 |
| セッション | 30日 | 週次 |
| 監査ログ | 1年 | 日次 |
| 通知履歴 | 30日 | 週次 |
| 同期ジョブログ | 3ヶ月 | 週次 |

## 9. セキュリティ実装

### 9.1 暗号化実装

```sql
-- 機微データの暗号化関数
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data TEXT)
RETURNS TEXT AS $$
BEGIN
    -- AES-256-GCM暗号化（実装時にライブラリ使用）
    RETURN pgp_sym_encrypt(data, current_setting('app.encryption_key'),
                          'cipher-algo=aes256,compress-algo=1');
END;
$$ LANGUAGE plpgsql;

-- 復号化関数
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN pgp_sym_decrypt(encrypted_data, current_setting('app.encryption_key'));
END;
$$ LANGUAGE plpgsql;
```

### 9.2 Row Level Security

```sql
-- 現在のユーザーID取得関数
CREATE OR REPLACE FUNCTION current_user_id()
RETURNS UUID AS $$
BEGIN
    RETURN NULLIF(current_setting('app.current_user_id', true), '')::UUID;
END;
$$ LANGUAGE plpgsql;

-- RLS ポリシー例
CREATE POLICY tasks_isolation_policy ON sync_tasks
    FOR ALL TO authenticated_users
    USING (user_id = current_user_id())
    WITH CHECK (user_id = current_user_id());
```

## 10. 監視・メンテナンス

### 10.1 ヘルスチェック

```sql
-- データベースヘルスチェッククエリ
SELECT
    'database' as component,
    CASE
        WHEN (SELECT 1) = 1 THEN 'healthy'
        ELSE 'unhealthy'
    END as status,
    NOW() as checked_at;

-- パフォーマンス監視クエリ
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY tablename, attname;
```

### 10.2 自動メンテナンス

```sql
-- 統計情報更新
CREATE OR REPLACE FUNCTION update_table_statistics()
RETURNS VOID AS $$
BEGIN
    ANALYZE sync_tasks;
    ANALYZE schedule_items;
    ANALYZE service_integrations;
END;
$$ LANGUAGE plpgsql;

-- 定期実行設定（cron job例）
-- 0 2 * * * psql -d myjarvis -c "SELECT update_table_statistics();"
```

## 11. 実装考慮事項

### 11.1 開発フェーズ

**Phase 1**: 基本スキーマ
- users, sync_tasks, user_preferences
- 基本認証・セッション管理

**Phase 2**: 外部サービス統合
- service_integrations, sync_jobs
- 暗号化実装

**Phase 3**: 高度な機能
- schedules, notification_history
- パフォーマンス最適化

**Phase 4**: 運用最適化
- 監査ログ、パーティション
- バックアップ・災害復旧

### 11.2 テスト戦略

```sql
-- テストデータ作成
INSERT INTO users (id, email, password_hash) VALUES
('test-user-1', 'test1@example.com', '$argon2id$v=19$m=65536,t=2,p=1$...');

-- パフォーマンステスト用大量データ
INSERT INTO sync_tasks (user_id, title, status)
SELECT
    'test-user-1',
    'Test Task ' || generate_series,
    CASE WHEN random() < 0.7 THEN 'active' ELSE 'completed' END
FROM generate_series(1, 10000);
```

## 12. 関連文書

- [01-システムアーキテクチャ設計](/docs/design/01-システムアーキテクチャ設計.md)
- [02-API設計](/docs/design/02-API設計.md)
- [ADR-005: データストレージ・プライバシー戦略](/docs/adr/ADR-005-データストレージ・プライバシー戦略.md)
- [ADR-006: リアルタイム同期戦略](/docs/adr/ADR-006-リアルタイム同期戦略.md)

---

*この設計書は、myJarvis システムの包括的なデータベース設計を提供し、プライバシー保護とパフォーマンスを両立した効率的なデータ管理を実現します。*